## Мультитенантная SaaS‑платформа интеграции МойСклад → Google Sheets

### Кратко
Платформа позволяет компаниям (арендаторам) подключать свой аккаунт МойСклад и свою Google Таблицу, настраивать экспорт 20+ сущностей, управлять задачами, лимитами и получать уведомления. Данные строго изолированы по company_id. Все I/O асинхронные, тяжёлые операции выполняются в фоновом режиме (Celery).

### Ключевые возможности
- **Мультитенантность**: изоляция данных по `company_id`, контекст в логах/метриках, опционально RLS в PostgreSQL.
- **Интеграции**: OAuth2 Google, подключение МойСклад; шифрование и ротация токенов.
- **Экспортеры (20+)**: модульная система на базе `BaseExporter` (orders, demand, payments, products, customers и др.), инкрементальная синхронизация, идемпотентность, батч‑операции в Sheets.
- **Планирование**: cron‑расписания, ручной запуск, триггеры по вебхукам МС.
- **Биллинг**: планы, usage‑счётчики, soft/hard‑лимиты, блокировки.
- **Наблюдаемость**: структурные логи, метрики Prometheus, OpenTelemetry трейсинг, Sentry.
- **SSO из МойСклад**: вход из интерфейса МС, выдача нашего JWT.
- **Кросс‑компанийные автоматизации**: события из компании A могут порождать операции в компании B (см. ниже).
- **Telegram‑уведомления дилерам/партнёрам**: оповещения о заказах, платежах, отгрузках по выбранной точке продаж.

### Фичи по вашим расширениям
- **Кросс‑компанийные сущности**: 
  - Правила вида «При событии X у компании A → создать сущность Y у компании B с маппингом полей и пометкой источника». 
  - Реализуется через `AutomationRule` и фоновые задачи. Идемпотентность по (source_id, rule_id). Проверка прав обеих компаний.
  - Примеры: `Отгрузка(A) → Приёмка(B)`, `Заказ(A) → Заказ(B)`.
- **Telegram дилерам**:
  - Справочник дилеров/партнёров с привязкой к точкам продаж и Telegram Chat ID.
  - Триггеры: создание заказа, входящий платёж, отгрузка.
  - Формат: краткое сообщение + ссылки; троттлинг и повтор на ошибках.

### Поток данных (высокоуровнево)
1) Пользователь запускает приложение из МойСклад → SSO → попадает в панель своей компании.  
2) Подключает Google (OAuth) и подтверждает доступ.  
3) Создаёт ExportConfig: сущность, фильтры, маппинг, стратегия записи (append/upsert/replace), расписание.  
4) Планировщик/вебхук запускает ExportTask → Celery‑воркер забирает данные из МС партиями → трансформирует → батч‑записывает в Google Sheets.  
5) Логи/метрики/уведомления и биллинг обновляются по итогам прогона.  
6) При срабатывании `AutomationRule` создаются «перекрёстные» сущности между компаниями.  
7) При наличии дилера у заказа отправляются Telegram‑уведомления.

### Архитектура (стек)
- Backend: FastAPI (async) + SQLAlchemy + PostgreSQL + Redis + Celery(+Beat)
- Frontend: отдельный проект (React/Vue)
- Инфраструктура: Docker, Nginx, Beget VPS
- Аутентификация: JWT + OAuth2 (Google + МойСклад)

### Соглашения
- Формат дат/времени: `DD.MM.YYYY HH:MM:SS`.
- Каждый запрос и задача логируются с `company_id` и `request_id`.
- Любые операции над данными клиента выполняются с учётом ограничений тарифного плана и квот внешних API.

### Запуск (dev)
```bash
docker-compose up -d
alembic upgrade head
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### Директория документации
- ARCHITECTURE.md — подробная архитектура и потоки
- API_DESIGN.md — контракт REST API и события
- DATA_MODELS.md — модели БД и связи
- TECHNICAL_SPEC.md — нефункциональные требования, квоты, ретраи
- DEPLOYMENT.md — деплой на Beget, секреты, бэкапы
- ROADMAP.md — план по этапам

### Дальше
1) Уточняем схемы данных и контракты API (доки в этом репо).  
2) Генерируем каркас проекта и минимальный API.  
3) Реализуем 3–5 экспортеров и основные фичи (AutomationRule, Telegram).  


